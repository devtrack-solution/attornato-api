# ==========================================
# üèóÔ∏è  Build Stage
# ==========================================
FROM node:20-alpine AS build

# Install pnpm globally
RUN npm install -g pnpm

# Set PNPM_HOME manually
ENV PNPM_HOME="/root/.pnpm-store"
ENV PATH="$PNPM_HOME/bin:$PATH"

# Create PNPM home directory manually
RUN mkdir -p $PNPM_HOME

# Install NestJS CLI globally (without pnpm setup)
RUN npm add -g @nestjs/cli

# Set working directory
WORKDIR /usr/src/app

# Copy package.json and install dependencies
COPY package.json ./
COPY pnpm-lock.yaml ./
RUN yes | pnpm install --no-frozen-lockfile

# Copy source code
COPY . .

# Build TypeScript
# RUN pnpm run build

# ==========================================
# üöÄ App Stage (Final Minimal Image)
# ==========================================
FROM node:20-alpine AS app

# Install pnpm globally
RUN npm install -g pnpm

# Set PNPM_HOME manually
ENV PNPM_HOME="/root/.pnpm-store"
ENV PATH="$PNPM_HOME/bin:$PATH"

# Create PNPM home directory manually
RUN mkdir -p $PNPM_HOME

# Install NestJS CLI globally (without pnpm setup)
RUN npm add -g @nestjs/cli

# Set working directory
WORKDIR /usr/src/app

# Copy necessary files from build stage
COPY --from=build /usr/src/app .

RUN pnpm config set allow-scripts true
RUN yes | pnpm install --no-frozen-lockfile

# Set environment variable
ENV NODE_ENV=DEVELOPMENT

# Run migrations
# RUN pnpm migration:run

# Start application dynamically based on RUN_DEBUG
CMD ["sh", "-c", "if [ \"$RUN_DEBUG\" = \"true\" ]; then exec pnpm run start:debug; else exec pnpm run start:dev; fi"]
